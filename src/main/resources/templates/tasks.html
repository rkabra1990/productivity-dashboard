<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>Tasks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            padding: 20px; 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
        }
        .priority-HIGH { 
            background-color: #dc3545; 
            color: white; 
        }
        .priority-MEDIUM { 
            background-color: #ffc107; 
            color: #000; 
        }
        .priority-LOW { 
            background-color: #0d6efd; 
            color: white; 
        }
        .task-completed { 
            text-decoration: line-through; 
            opacity: 0.7; 
            color: #a0a0a0;
        }
        .task-item { 
            transition: all 0.3s ease; 
        }
        .card { 
            background-color: #2d2d2d; 
            border: 1px solid #444; 
            color: #e0e0e0;
        }
        .card-header { 
            background-color: #1e1e1e; 
            border-bottom: 1px solid #444; 
            color: #ffffff;
        }
        .table { 
            color: #e0e0e0; 
        }
        .table th {
            color: #ffffff;
            border-color: #444;
        }
        .table td {
            border-color: #444;
            vertical-align: middle;
        }
        .table-hover tbody tr:hover { 
            background-color: #3d3d3d; 
        }
        .form-control, .form-select { 
            background-color: #3d3d3d; 
            border: 1px solid #555; 
            color: #ffffff; 
        }
        .form-control:focus, .form-select:focus { 
            background-color: #4d4d4d; 
            color: #ffffff; 
            border-color: #666;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .form-label {
            color: #e0e0e0;
        }
        .text-muted {
            color: #9e9e9e !important;
        }
        .alert {
            color: #e0e0e0;
        }
        .alert-info {
            background-color: rgba(13, 202, 240, 0.1);
            border-color: rgba(13, 202, 240, 0.2);
        }
        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.2);
        }
    </style>
</head>
<body>
<!-- Include Header Fragment -->
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="h4 mb-0">Tasks</h2>
      <div class="d-flex align-items-center">
        <form method="get" th:action="@{/tasks}" class="d-flex me-3">
          <select class="form-select form-select-sm me-2" name="year" onchange="this.form.submit()">
            <option th:each="y : ${years}" 
                    th:value="${y}" 
                    th:text="${y}"
                    th:selected="${y == selectedYear}"></option>
          </select>
        </form>
      </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="card-header p-0">
      <ul class="nav nav-tabs" id="tasksTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
            Pending Tasks
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab" aria-controls="completed" aria-selected="false">
            Completed Tasks
          </button>
        </li>
      </ul>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content p-3" id="tasksTabContent">
      <!-- Pending Tasks Tab -->
      <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
        <div class="mb-4">
          <h3>Pending Tasks</h3>
          <p class="text-muted">
            <span th:text="${tasks != null ? tasks.size() : 0}">0</span> pending tasks | 
            <span th:text="${completedTasksCount}">0</span> completed
          </p>
        </div>

        <!-- Add New Task Form -->
        <div class="card-body">
          <h5 class="card-title">Add New Task</h5>
          <form action="/tasks/add" method="post" class="row g-2">
            <div class="col-md-3">
              <input type="text" class="form-control" name="title" placeholder="Task name" required>
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control" name="category" placeholder="Category">
            </div>
            <div class="col-md-2">
              <select class="form-select" name="priority">
                <option value="LOW">Low Priority</option>
                <option value="MEDIUM" selected>Medium Priority</option>
                <option value="HIGH">High Priority</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="datetime-local" class="form-control" name="dueDate" required>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Add Task</button>
            </div>
          </form>
        </div>
        
        <!-- Task List for Pending Tasks -->
        <div class="card">
          <div class="card-body">
            <div th:if="${tasks != null and !tasks.empty}">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Task</th>
                      <th>Category</th>
                      <th>Priority</th>
                      <th>Due Date</th>
                      <th>Status</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="task : ${tasks}" th:classappend="${task.completed} ? 'table-active' : ''">
                      <td th:classappend="${task.completed} ? 'task-completed' : ''" th:text="${task.title}"></td>
                      <td>
                        <span th:if="${task.category}" class="badge bg-secondary" th:text="${task.category}"></span>
                      </td>
                      <td>
                        <span class="badge" th:classappend="'priority-' + ${task.priority}" th:text="${task.priority}"></span>
                      </td>
                      <td th:text="${#temporals.format(task.dueDate, 'MMM dd, yyyy')}"></td>
                      <td>
                        <form th:action="@{/tasks/toggle}" method="post" class="d-inline">
                          <input type="hidden" name="id" th:value="${task.id}" />
                          <button type="submit" class="btn btn-sm" 
                                  th:classappend="${task.completed} ? 'btn-success' : 'btn-outline-secondary'">
                            <span th:if="${task.completed}">
                              âœ“ Done <small class="text-muted" th:if="${task.completionTimestamp}" 
                              th:text="'(' + ${#temporals.format(task.completionTimestamp, 'MMM dd, yyyy HH:mm')} + ')'"></small>
                            </span>
                            <span th:if="!${task.completed}">Mark Done</span>
                          </button>
                        </form>
                      </td>
                      <td class="text-end">
                        <div class="btn-group btn-group-sm">
                          <button type="button" class="btn btn-outline-primary edit-btn" 
                                  data-bs-toggle="modal" data-bs-target="#editTaskModal"
                                  th:attr="data-id=${task.id},
                                           data-name=${task.title},
                                           data-category=${task.category},
                                           data-priority=${task.priority},
                                           data-due=${#temporals.format(task.dueDate, 'yyyy-MM-dd')} + 'T' + ${#temporals.format(task.dueDate, 'HH:mm')}">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <a th:href="@{'/tasks/delete/' + ${task.id}}" 
                             class="btn btn-outline-danger"
                             onclick="return confirm('Are you sure you want to delete this task?')">
                            <i class="fas fa-trash"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div th:if="${tasks == null or tasks.empty}" class="alert alert-warning mb-0">
              No tasks found. Add a new task using the form above.
            </div>
          </div>
        </div>
        
        <!-- Edit Task Modal -->
        <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <form action="/tasks/update" method="post" class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="id" id="edit-id" />
                <div class="mb-3">
                  <label for="edit-title" class="form-label">Task Title</label>
                  <input type="text" class="form-control" id="edit-title" name="title" required>
                </div>
                <div class="mb-3">
                  <label for="edit-category" class="form-label">Category</label>
                  <input type="text" class="form-control" id="edit-category" name="category">
                </div>
                <div class="mb-3">
                  <label for="edit-priority" class="form-label">Priority</label>
                  <select class="form-select" id="edit-priority" name="priority">
                    <option value="LOW">Low</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="edit-dueDate" class="form-label">Due Date</label>
                  <input type="datetime-local" class="form-control" id="edit-dueDate" name="dueDate">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save changes</button>
              </div>
            </form>
          </div>
        </div>
        
        <script>
          // Handle edit modal population
          document.addEventListener('DOMContentLoaded', function() {
            var editModal = document.getElementById('editTaskModal');
            if (editModal) {
              editModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var id = button.getAttribute('data-id');
                var title = button.getAttribute('data-name');
                var category = button.getAttribute('data-category') || '';
                var priority = button.getAttribute('data-priority');
                var dueDate = button.getAttribute('data-due');
                
                var modalTitle = editModal.querySelector('.modal-title');
                var modalId = editModal.querySelector('#edit-id');
                var modalTitleInput = editModal.querySelector('#edit-title');
                var modalCategory = editModal.querySelector('#edit-category');
                var modalPriority = editModal.querySelector('#edit-priority');
                var modalDueDate = editModal.querySelector('#edit-dueDate');
                
                modalTitle.textContent = 'Edit Task';
                modalId.value = id;
                modalTitleInput.value = title;
                modalCategory.value = category;
                modalPriority.value = priority;
                modalDueDate.value = dueDate;
              });
            }
          });
        </script>
        
      </div> <!-- End of Pending Tasks Tab -->
      
      <!-- Completed Tasks Tab -->
      <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0">Completed Tasks</h3>
              <p class="text-muted mb-0">
                <span th:text="${completedTasksCount}">0</span> <span th:text="${completedTasksCount == 1 ? 'task' : 'tasks'}">tasks</span> completed
              </p>
            </div>
            <div th:if="${not #maps.isEmpty(tasksByMonth)}">
              <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="fas fa-file-export me-1"></i> Export
              </button>
            </div>
          </div>
        </div>
        
        <div th:if="${not #maps.isEmpty(tasksByMonth)}">
          <!-- Month Tabs -->
          <ul class="nav nav-tabs mb-3" id="monthTabs" role="tablist">
            <li class="nav-item" role="presentation" th:each="monthEntry : ${tasksByMonth}">
              <button class="nav-link" 
                      th:classappend="${monthEntry.key == selectedMonth ? 'active' : ''}"
                      th:with="monthId=${#strings.replace(monthEntry.key, ' ', '-')}"
                      th:id="'month-' + ${monthId}"
                      th:attr="data-bs-target='#month-' + ${monthId} + '-content'"
                      th:aria-controls="'month-' + ${monthId}"
                      th:aria-selected="${monthEntry.key == selectedMonth ? 'true' : 'false'}"
                      data-bs-toggle="tab" 
                      type="button" 
                      role="tab">
                <span th:text="${monthEntry.key}"></span>
                <span class="badge bg-primary ms-1" th:text="${monthEntry.value.size()}"></span>
              </button>
            </li>
          </ul>
          
          <!-- Month Tab Content -->
          <div class="tab-content" id="monthTabsContent">
            <div th:each="monthEntry : ${tasksByMonth}" 
                 th:with="monthId=${#strings.replace(monthEntry.key, ' ', '-')}"
                 th:class="'tab-pane fade' + (${monthEntry.key == selectedMonth} ? ' show active' : '')"
                 th:id="'month-' + ${monthId} + '-content'"
                 role="tabpanel">
                 
              <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-sm btn-danger delete-month-btn" 
                        th:data-month="${monthEntry.key}"
                        th:title="'Delete all tasks for ' + ${monthEntry.key}">
                  <i class="fas fa-trash me-1"></i> Delete All
                </button>
              </div>
              
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Task</th>
                      <th>Category</th>
                      <th>Priority</th>
                      <th>Due Date</th>
                      <th>Completed On</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="task : ${monthEntry.value}">
                      <td th:text="${task.title}" class="text-decoration-line-through"></td>
                      <td>
                        <span th:if="${task.category}" class="badge bg-secondary" th:text="${task.category}"></span>
                      </td>
                      <td>
                        <span class="badge" 
                              th:class="${task.priority != null ? 'priority-' + #strings.toLowerCase(task.priority) : ''}" 
                              th:text="${task.priority}"></span>
                      </td>
                      <td th:text="${#temporals.format(task.dueDate, 'MMM dd, yyyy')}"></td>
                      <td th:text="${#temporals.format(task.completionTimestamp, 'MMM dd, yyyy HH:mm')}"></td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                th:onclick="'deleteTask(' + ${task.id} + ')'"
                                title="Delete this task">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div th:if="${#maps.isEmpty(tasksByMonth)}" class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i> No completed tasks found. Tasks will appear here once marked as completed.
        </div>
      </div>
    </div>
  </div>
</div>

      <!-- Export Modal -->
      <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Export Completed Tasks</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="exportForm" th:action="@{/tasks/export-year}" method="get">
                <div class="mb-3">
                  <label for="exportYear" class="form-label">Select Year to Export</label>
                  <select class="form-select" id="exportYear" name="year" required>
                    <option th:each="y : ${years}" 
                            th:value="${y}" 
                            th:text="${y}"
                            th:selected="${y == selectedYear}"></option>
                  </select>
                </div>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i> Exports will be in Excel format (.xls)
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" form="exportForm">Export</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm Deletion</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this task?</p>
              <form id="deleteForm" method="post">
                <input type="hidden" name="_method" value="delete">
                <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}">
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger" form="deleteForm">Delete</button>
            </div>
          </div>
        </div>
      </div>

<!-- Add CSRF token at the top of the body -->
<div style="display:none">
  <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}" id="csrfToken">
</div>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<script>
  // Function to handle task deletion
  function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
      const form = document.createElement('form');
      form.method = 'post';
      form.action = '/tasks/delete/' + taskId;
      
      // Add CSRF token from the hidden input
      const csrfToken = document.getElementById('csrfToken');
      if (csrfToken && csrfToken.value) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
      }
      
      // Add method override for DELETE
      const methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'delete';
      form.appendChild(methodInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  }
  
  // Function to handle deletion of all tasks in a month
  function deleteMonthTasks(month) {
    if (confirm('Are you sure you want to delete all tasks for ' + month + '? This action cannot be undone.')) {
      const form = document.createElement('form');
      form.method = 'post';
      form.action = '/tasks/delete/month';
      
      // Add month parameter
      const monthInput = document.createElement('input');
      monthInput.type = 'hidden';
      monthInput.name = 'month';
      monthInput.value = month;
      form.appendChild(monthInput);
      
      // Add CSRF token from the hidden input
      const csrfToken = document.getElementById('csrfToken');
      if (csrfToken && csrfToken.value) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
      }
      
      // Add method override for DELETE
      const methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'delete';
      form.appendChild(methodInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  }
  
  // Initialize tooltips
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Handle delete month button clicks
    document.querySelectorAll('.delete-month-btn').forEach(button => {
      button.addEventListener('click', function() {
        const month = this.getAttribute('data-month');
        if (month && confirm('Are you sure you want to delete all tasks for ' + month + '?')) {
          deleteMonthTasks(month);
        }
      });
    });
  });
</script>

</body>
</html>
