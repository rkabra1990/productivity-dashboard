<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>Tasks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding: 20px; background-color: #1a1a1a; color: #ffffff; }
        .priority-HIGH { background-color: #dc3545; color: white; }
        .priority-MEDIUM { background-color: #ffc107; color: #000; }
        .priority-LOW { background-color: #0d6efd; color: white; }
        .task-completed { text-decoration: line-through; opacity: 0.7; }
        .task-item { transition: all 0.3s ease; }
        .card { background-color: #2d2d2d; border: 1px solid #444; }
        .card-header { background-color: #1e1e1e; border-bottom: 1px solid #444; }
        .table { color: #ffffff; }
        .table-hover tbody tr:hover { background-color: #3d3d3d; }
        .form-control, .form-select { background-color: #3d3d3d; border: 1px solid #555; color: #ffffff; }
        .form-control:focus, .form-select:focus { background-color: #4d4d4d; color: #ffffff; }
    </style>
</head>
<body>
<!-- Include Header Fragment -->
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h2 class="h4 mb-0">Tasks</h2>
    </div>
    <div th:if="${testMessage}" th:text="${testMessage}" class="fw-bold"></div>
  </div>
  <div class="mb-4">
    <h3>Task List</h3>
    <p class="text-muted">Total tasks: <span th:text="${tasks != null ? tasks.size() : 0}">0</span></p>
  </div>

  <!-- Add New Task Form -->
    <div class="card-body">
      <h5 class="card-title">Add New Task</h5>
      <form action="/tasks/add" method="post" class="row g-2">
        <div class="col-md-3">
          <input type="text" class="form-control" name="title" placeholder="Task name" required>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" name="category" placeholder="Category">
        </div>
        <div class="col-md-2">
          <select class="form-select" name="priority">
            <option value="LOW">Low Priority</option>
            <option value="MEDIUM" selected>Medium Priority</option>
            <option value="HIGH">High Priority</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="datetime-local" class="form-control" name="dueDate" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Add Task</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Task List -->
  <div class="card">
    <div class="card-body">
      <div th:if="${tasks != null and !tasks.empty}">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Task</th>
                <th>Category</th>
                <th>Priority</th>
                <th>Due Date</th>
                <th>Status</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="task : ${tasks}" th:classappend="${task.completed} ? 'table-active' : ''">
                <td th:classappend="${task.completed} ? 'task-completed' : ''" th:text="${task.title}"></td>
                <td>
                  <span th:if="${task.category}" class="badge bg-secondary" th:text="${task.category}"></span>
                </td>
                <td>
                  <span class="badge" th:classappend="'priority-' + ${task.priority}" th:text="${task.priority}"></span>
                </td>
                <td th:text="${#temporals.format(task.dueDate, 'MMM dd, yyyy')}"></td>
                <td>
                  <form th:action="@{/tasks/toggle}" method="post" class="d-inline">
                    <input type="hidden" name="id" th:value="${task.id}" />
                    <button type="submit" class="btn btn-sm" 
                            th:classappend="${task.completed} ? 'btn-success' : 'btn-outline-secondary'">
                      <span th:if="${task.completed}">âœ“ Done</span>
                      <span th:if="!${task.completed}">Mark Done</span>
                    </button>
                  </form>
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary edit-btn" 
                            data-bs-toggle="modal" data-bs-target="#editTaskModal"
                            th:attr="data-id=${task.id},
                                     data-name=${task.title},
                                     data-category=${task.category},
                                     data-priority=${task.priority},
                                     data-due=${#temporals.format(task.dueDate, 'yyyy-MM-dd')} + 'T' + ${#temporals.format(task.dueDate, 'HH:mm')}">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <a th:href="@{'/tasks/delete/' + ${task.id}}" 
                       class="btn btn-outline-danger"
                       onclick="return confirm('Are you sure you want to delete this task?')">
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div th:if="${tasks == null or tasks.empty}" class="alert alert-warning mb-0">
        No tasks found. Add a new task using the form above.
      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form action="/tasks/update" method="post" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="edit-id" />
          <div class="mb-3">
            <label for="edit-title" class="form-label">Task Title</label>
            <input type="text" class="form-control" id="edit-title" name="title" required>
          </div>
          <div class="mb-3">
            <label for="edit-category" class="form-label">Category</label>
            <input type="text" class="form-control" id="edit-category" name="category">
          </div>
          <div class="mb-3">
            <label for="edit-priority" class="form-label">Priority</label>
            <select class="form-select" id="edit-priority" name="priority">
              <option value="LOW">Low</option>
              <option value="MEDIUM">Medium</option>
              <option value="HIGH">High</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-dueDate" class="form-label">Due Date</label>
            <input type="datetime-local" class="form-control" id="edit-dueDate" name="dueDate">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  // Handle edit button click
  document.addEventListener('DOMContentLoaded', function() {
    const editButtons = document.querySelectorAll('.edit-btn');
    const editForm = document.querySelector('#editTaskModal form');
    
    editButtons.forEach(button => {
      button.addEventListener('click', function() {
        const taskId = this.getAttribute('data-id');
        const taskName = this.getAttribute('data-name');
        const taskCategory = this.getAttribute('data-category') || '';
        const taskPriority = this.getAttribute('data-priority');
        const taskDue = this.getAttribute('data-due');
        
        // Set form values
        editForm.querySelector('input[name="id"]').value = taskId;
        editForm.querySelector('input[name="title"]').value = taskName;
        editForm.querySelector('input[name="category"]').value = taskCategory;
        editForm.querySelector('select[name="priority"]').value = taskPriority;
        editForm.querySelector('input[name="dueDate"]').value = taskDue;
      });
    });
  });
  </script>
</div>

</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form action="/tasks/update" method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="edit-id" />
        <div class="mb-3">
          <label for="edit-title" class="form-label">Task Title</label>
          <input type="text" class="form-control" id="edit-title" name="title" required>
        </div>
        <div class="mb-3">
          <label for="edit-category" class="form-label">Category</label>
          <input type="text" class="form-control" id="edit-category" name="category">
        </div>
        <div class="mb-3">
          <label for="edit-priority" class="form-label">Priority</label>
          <select class="form-select" id="edit-priority" name="priority">
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="edit-dueDate" class="form-label">Due Date</label>
          <input type="datetime-local" class="form-control" id="edit-dueDate" name="dueDate">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
// Handle edit button click
document.addEventListener('DOMContentLoaded', function() {
  const editButtons = document.querySelectorAll('.edit-btn');
  
  editButtons.forEach(button => {
    button.addEventListener('click', function() {
      const taskId = this.getAttribute('data-id');
      const taskName = this.getAttribute('data-name');
      const taskCategory = this.getAttribute('data-category') || '';
      const taskPriority = this.getAttribute('data-priority');
      const taskDue = this.getAttribute('data-due');
      
      // Set form values
      document.getElementById('edit-id').value = taskId;
      document.getElementById('edit-title').value = taskName;
      document.getElementById('edit-category').value = taskCategory;
      document.getElementById('edit-priority').value = taskPriority;
      document.getElementById('edit-dueDate').value = taskDue;
    });
  });
});

// Simple toggle task function
function toggleTask(checkbox, event) {
  event.preventDefault();
  const form = checkbox.closest('form');
  form.submit();
}
</script>

</body>
</html>
</div>
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form th:action="@{/tasks/update}" method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTaskLabel">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="edit-id">

        <label for="edit-name">Name:</label>
        <input type="text" class="form-control" name="title" id="edit-name" required>

        <label for="edit-category">Category:</label>
        <input type="text" class="form-control" name="category" id="edit-category">

        <label for="edit-priority">Priority:</label>
        <select class="form-control" name="priority" id="edit-priority">
          <option value="HIGH">High</option>
          <option value="MEDIUM">Medium</option>
          <option value="LOW">Low</option>
        </select>

        <label for="edit-dueDate">Due Date:</label>
        <input type="datetime-local" class="form-control" name="dueDate" id="edit-dueDate">
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Update</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
<div class="container mt-5">
  <h3 class="text-light">ðŸ“… View Tasks by Year</h3>

  <form method="get" th:action="@{/tasks}" class="row g-3 mb-4">
    <div class="col-auto">
      <select class="form-select bg-dark text-white border-secondary"
              name="year"
              onchange="this.form.submit()">
        <option th:each="y : ${years}" th:value="${y}" th:text="${y}"
                th:selected="${y == selectedYear}"></option>
      </select>
    </div>
  </form>
  <form method="post" th:action="@{/tasks/delete-year}" class="d-inline">
    <input type="hidden" name="year" th:value="${selectedYear}" />
    <button type="submit" class="btn btn-danger btn-sm me-2">ðŸ—‘ Delete Year</button>
  </form>

  <a th:href="@{/tasks/export-year(year=${selectedYear})}" class="btn btn-outline-success btn-sm">ðŸ“¥ Export to Excel</a>

  <div th:each="entry : ${tasksByMonth}" class="accordion mb-3" id="accordion-tasks">
    <div class="accordion-item bg-dark text-white border-secondary">
      <h2 class="accordion-header">
        <button class="accordion-button bg-dark text-white collapsed" type="button"
                data-bs-toggle="collapse" th:attr="data-bs-target='#month__' + ${entry.key.name()}">
          <span th:text="${entry.key}">JANUARY</span>
        </button>
      </h2>
      <div th:attr="id='month__' + ${entry.key.name()}" class="accordion-collapse collapse"
           data-bs-parent="#accordion-tasks">
        <div class="accordion-body">
          <ul class="list-group">
            <li th:each="task : ${entry.value}"
                class="list-group-item bg-dark text-white border-secondary"
                th:text="${task.title} + ' â€” ' + ${#temporals.format(task.dueDate, 'yyyy-MM-dd HH:mm')}">
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:if="${tasksByMonth.isEmpty()}">
  <p class="text-warning">No tasks found for [[${selectedYear}]].</p>
</div>
<div th:replace="fragments/footer :: footer"></div>
  <script>
  // Simple toggle task function
  function toggleTask(checkbox, event) {
    event.preventDefault();
    const form = checkbox.closest('form');
    form.submit();
  }
  
  // Handle edit button click
  document.addEventListener('DOMContentLoaded', function() {
    const editButtons = document.querySelectorAll('.edit-btn');
    const editForm = document.querySelector('#editTaskModal form');
        document.getElementById("edit-category").value = this.dataset.category || '';
        document.getElementById("edit-priority").value = this.dataset.priority;
        document.getElementById("edit-dueDate").value = this.dataset.due;
      });
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>


</body>
</html>
